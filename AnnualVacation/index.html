<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vacation Planner (Vanilla JS • Phone Mock)</title>
  <style>
    :root {
      --ink:#1f2937; --muted:#6b7280; --bg:#f3f4c6; --card:#ffffff;
      --brand:#0F2133; --brand-d:#08121a; --ok:#16a34a; --warn:#ca8a04; --bad:#dc2626;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; color:var(--ink); background:var(--bg); }
    .container { max-width: 1024px; margin: 24px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding:24px; }
    h1 { margin:0 0 16px; font-size:28px; }
    h2 { margin:16px 0 8px; font-size:18px; }
    .row { display:flex; gap:12px; align-items:center; }
    .row.wrap { flex-wrap: wrap; }
    .col { flex:1; min-width: 220px; }
    label { display:block; font-size:14px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="date"] { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; background:#fff; }
    input:focus { border-color:#93c5fd; box-shadow:0 0 0 4px rgba(2,132,199,.15); }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; }
    button { appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; background:var(--brand); color:white; }
    button.secondary { background:#6b7280; }
    button.ghost { background:transparent; color:#2563eb; padding:0; }
    button.ok { background:var(--ok); }
    button.bad { background:var(--bad); }
    button.warn { background:#374151; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
    .PENDING { background:#fef3c7; color:#92400e; }
    .APPROVED { background:#dcfce7; color:#166534; }
    .REJECTED { background:#fee2e2; color:#991b1b; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #f1f5f9; vertical-align: top; }
    thead th { font-size:12px; letter-spacing:.06em; color:#6b7280; text-transform:uppercase; }
    .muted { color:var(--muted); }
    .statbar { display:flex; justify-content:space-between; background:#f8fafc; padding:10px 12px; border-radius:10px; }
    .chip-btn { width:28px; height:28px; border-radius:999px; display:flex; justify-content:center; align-items:center; font-weight:800; }
    .center { text-align:center; }
    .hidden { display:none !important; }

    /* Calendar styles */
    .calendar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 12px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
      width: 100%;
    }
    .day-name { font-size: 12px; color: var(--muted); }
    .day {
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .day:hover:not(.empty):not(.in-range):not(.selected) { background-color: #f1f5f9; }
    .day.empty { visibility: hidden; }
    .day.selected {
      background-color: var(--brand-d);
      color: white;
      font-weight: 600;
    }
    .day.in-range {
      background-color: rgba(15, 33, 51, 0.1); /* light brand color */
      border-radius: 0;
    }
    .day.in-range.start-of-range {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    .day.in-range.end-of-range {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    /* ------------------ PHONE MOCK ------------------ */
    .phone-shell { display:flex; justify-content:center; }
    .phone-body {
      position:relative; width:390px; height:780px; background:#000; border-radius:36px; padding:12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .phone-body:before { /* side button */
      content:""; position:absolute; right:-4px; top:120px; width:3px; height:80px; background:#0e0e0e; border-radius:2px;
    }
    .phone-screen {
      position:relative; width:100%; height:100%; border-radius:28px; background:#f3f4f6; overflow:hidden; display:flex; flex-direction:column;
    }
    .phone-notch { position:absolute; top:8px; left:50%; transform:translateX(-50%); width:180px; height:24px; background:#000; border-radius:0 0 18px 18px; z-index:2; }
    .appbar { height:56px; background:var(--brand); color:white; display:flex; align-items:center; gap:10px; padding:0 14px; font-weight:700; position:relative; z-index:1; }
    .appbar button { background:transparent; color:white; padding:6px 8px; border-radius:8px; }
    .phone-content { flex:1; overflow-y:auto; padding:16px; }


    /* Make content look mobile-first inside the phone */
    .phone-content .row { flex-direction:column; align-items:stretch; }
    .phone-content .col { min-width: unset; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="view-home">
      <h1>Vacation Planner</h1>
      <div class="toolbar">
        <button id="go-employee">Employee Vacation Request</button>
        <button id="go-supervisor" class="warn">Supervisor Dashboard</button>
      </div>
      <p class="muted" style="margin-top:12px">This demo wraps the Employee page inside a phone frame to preview the mobile UX.</p>
    </div>


    <!-- Employee in a Phone Mock -->
    <div class="card hidden" id="view-employee">
      <div class="toolbar" style="margin-bottom:12px">
        <button class="ghost" id="back-from-employee">&larr; Back to Home</button>
      </div>


      <div class="phone-shell">
        <div class="phone-body">
          <div class="phone-notch"></div>
          <div class="phone-screen" role="region" aria-label="Mobile preview">
            <div class="appbar">
              <button id="mobile-back" title="Back">&larr;</button>
              <div>Employee Vacation Request</div>
            </div>
            <div class="phone-content">
              <div class="row wrap">
                <div class="col">
                  <label for="emp-name">Name</label>
                  <input id="emp-name" type="text" placeholder="Your name" />
                </div>
                <div class="col">
                  <label for="emp-seniority">Seniority Date</label>
                  <input id="emp-seniority" type="date" />
                </div>
              </div>


              <div class="statbar" style="margin-top:12px">
                <div>Years of Service: <strong id="stat-years">0</strong></div>
                <div>Weeks of Vacation: <strong id="stat-weeks">0</strong></div>
              </div>


              <h2>Request Weeks</h2>
              <div class="row" style="justify-content:space-between; align-items:center">
                <div class="muted">Week <strong id="wk-index">1</strong> of <strong id="wk-total">0</strong></div>
                <div class="toolbar">
                  <button id="btn-add-option" class="chip-btn" title="Add option">+</button>
                  <button id="btn-remove-option" class="chip-btn warn" title="Remove option">&minus;</button>
                </div>
              </div>


              <div id="options-wrap" style="margin-top:8px"></div>


              <div class="toolbar" style="justify-content:space-between; margin-top:16px">
                <button id="btn-prev" class="secondary">Previous</button>
                <div class="toolbar">
                  <button id="btn-next">Next</button>
                  <button id="btn-submit" class="ok hidden">Submit Request</button>
                </div>
              </div>
            </div> <!-- /phone-content -->
          </div> <!-- /phone-screen -->
        </div> <!-- /phone-body -->
      </div> <!-- /phone-shell -->
    </div>

    <!-- Confirmation Page -->
    <div class="card hidden" id="view-confirmation" style="text-align:center;">
        <h1>Request Submitted!</h1>
        <p class="muted">Your vacation request has been successfully submitted for review.</p>
        <button id="back-from-confirmation">Return to Home</button>
    </div>


    <!-- Supervisor -->
    <div class="card hidden" id="view-supervisor">
      <div class="toolbar" style="margin-bottom:12px">
        <button class="ghost" id="back-from-supervisor">&larr; Back to Home</button>
      </div>
      <h1>Supervisor Dashboard</h1>


      <div class="toolbar" style="justify-content:space-between; margin-bottom:8px">
        <div class="toolbar">
          <button id="btn-allocate">Allocate Vacations</button>
          <button id="btn-reset" class="secondary">Reset All Requests</button>
        </div>
        <span class="muted">Sorted by seniority (oldest first)</span>
      </div>


      <div class="card" style="padding:0">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Seniority Date</th>
              <th>Years</th>
              <th>Requested Dates</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="requests-tbody">
            <tr><td colspan="6" class="center muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- Message Modal -->
  <div class="notice hidden" id="notice" aria-live="polite">
    <div class="panel card" style="max-width:420px; margin:0 16px;">
      <div id="notice-text" style="margin-bottom:12px">Hello</div>
      <button id="notice-close">Close</button>
    </div>
  </div>


  <!-- OPTIONAL Firebase (works if you already expose window.firebaseConfig, window.appId, window.initialAuthToken) -->
  <script type="module">
    const hasFirebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config && Object.keys(JSON.parse(__firebase_config)).length > 0;
    if (hasFirebaseConfig) {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
      const { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
      const { getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, serverTimestamp, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
      window._fb = { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, serverTimestamp, getDocs };
    }
  </script>


  <!-- Main App -->
  <script>
    const state = {
      name: 'John Doe',
      seniorityDate: '2024-01-01',
      years: 0,
      weeks: 0,
      currentWeekIndex: 0,
      vacationDates: [],
      backend: { mode: 'memory', userId: 'local-user', ready: false, db: null, appId: 'default-app-id' },
      supervisor: { items: [] }
    };

    console.log("Setting firebase log level is not possible in this environment. It will be ignored.");


    const $ = sel => document.querySelector(sel);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');


    const views = { home: $('#view-home'), employee: $('#view-employee'), supervisor: $('#view-supervisor'), confirmation: $('#view-confirmation') };
    function navigate(to){ Object.values(views).forEach(hide); show(views[to]); if (to==='supervisor') loadSupervisor(); }


    function notify(msg, ms=3000){ $('#notice-text').textContent = msg; show($('#notice')); clearTimeout(notify._t); notify._t = setTimeout(()=>hide($('#notice')), ms); }
    $('#notice-close').addEventListener('click', ()=> hide($('#notice')));


    // Employee refs
    const $name = $('#emp-name');
    const $seniority = $('#emp-seniority');
    const $years = $('#stat-years');
    const $weeks = $('#stat-weeks');
    const $wkIndex = $('#wk-index');
    const $wkTotal = $('#wk-total');
    const $optionsWrap = $('#options-wrap');
    const $btnPrev = $('#btn-prev');
    const $btnNext = $('#btn-next');
    const $btnSubmit = $('#btn-submit');
    const $btnAddOpt = $('#btn-add-option');
    const $btnRemOpt = $('#btn-remove-option');


    function fmtDateISOToMDY(iso){ if (!iso) return ''; const d = new Date(iso); if (Number.isNaN(d)) return ''; const mm=String(d.getUTCMonth()+1).padStart(2,'0'); const dd=String(d.getUTCDate()).padStart(2,'0'); const yy=d.getUTCFullYear(); return `${mm}/${dd}/${yy}`; }


    function recomputeFromSeniority(){
      const sd = $seniority.value || ''; if (!sd){ state.years=0; state.weeks=0; paintEmployeeStats(); return; }
      const start = new Date(sd); const today = new Date();
      state.years = Math.max(0, Math.floor((today - start)/(1000*3600*24*365.25)));
      let w=0; if (state.years>=35) w=6; else if (state.years>=25) w=5; else if (state.years>=10) w=4; else if (state.years>=3) w=3; else if (state.years>=1) w=2;
      state.weeks = w;
      // Initialize vacationDates with a status for each week
      const cur = state.vacationDates||[]; state.vacationDates = Array.from({length:w}, (_,i)=> cur[i]?cur[i]:[{startDate:'',endDate:'', status:'pending'}]);
      if (state.currentWeekIndex>=w) state.currentWeekIndex = Math.max(0, w-1);
      
      // Initialize currentMonth to January 2026
      state.currentMonth = 0;

      paintEmployeeStats(); 
      paintWeek();
    }


    function paintEmployeeStats(){
      $years.textContent = state.years; $weeks.textContent = state.weeks; $wkIndex.textContent = (state.weeks===0?0:state.currentWeekIndex+1); $wkTotal.textContent = state.weeks;
      $btnPrev.disabled = (state.currentWeekIndex===0);
      hide($btnSubmit); hide($btnNext);
      if (state.weeks>0){ if (state.currentWeekIndex < state.weeks-1) show($btnNext); else show($btnSubmit); }
    }


    function paintWeek(){
      $optionsWrap.innerHTML = ''; if (state.weeks===0) return;
      
      const currentWeekOptions = state.vacationDates[state.currentWeekIndex];
      if (!currentWeekOptions || currentWeekOptions.length === 0) return;
      
      const option = currentWeekOptions[0];
      const selectedDates = {
        start: option.startDate ? new Date(option.startDate + 'T00:00:00') : null,
        end: option.endDate ? new Date(option.endDate + 'T00:00:00') : null
      };

      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const dayNames = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
      const currentYear = 2026;
      
      const firstDayOfMonth = new Date(currentYear, state.currentMonth, 1);
      const startDayOfWeek = firstDayOfMonth.getDay();
      const daysInMonth = new Date(currentYear, state.currentMonth + 1, 0).getDate();
      
      let daysHtml = dayNames.map(d => `<div class="day-name">${d}</div>`).join('');
      for (let i = 0; i < startDayOfWeek; i++) {
        daysHtml += '<div class="day empty"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, state.currentMonth, day);
        let classList = 'day';
        if (selectedDates.start && date >= selectedDates.start && date <= selectedDates.end) {
          classList += ' in-range';
          if (date.getTime() === selectedDates.start.getTime()) classList += ' selected start-of-range';
          if (date.getTime() === selectedDates.end.getTime()) classList += ' selected end-of-range';
        }
        if (selectedDates.start && date.getTime() === selectedDates.start.getTime()) classList += ' selected';
        if (selectedDates.end && date.getTime() === selectedDates.end.getTime()) classList += ' selected';
        
        daysHtml += `<div class="${classList}" data-date="${date.toISOString().slice(0,10)}">${day}</div>`;
      }
      
      const calendarContainer = document.createElement('div');
      calendarContainer.className = 'calendar-container';
      calendarContainer.innerHTML = `
        <div class="calendar-header">
            <button id="prev-month">&larr; Prev</button>
            <div style="font-weight: 600;">${monthNames[state.currentMonth]} ${currentYear}</div>
            <button id="next-month">Next &rarr;</button>
        </div>
        <div class="calendar-grid">${daysHtml}</div>
      `;
      $optionsWrap.appendChild(calendarContainer);
      
      $('#prev-month').addEventListener('click', () => {
          state.currentMonth = (state.currentMonth - 1 + 12) % 12;
          paintWeek();
      });
      
      $('#next-month').addEventListener('click', () => {
          state.currentMonth = (state.currentMonth + 1) % 12;
          paintWeek();
      });

      $optionsWrap.querySelectorAll('.day').forEach(dayEl => {
        dayEl.addEventListener('click', e => {
          const dateStr = e.target.dataset.date;
          if (!dateStr) return;
          const date = new Date(dateStr + 'T00:00:00');

          if (!option.startDate) {
            option.startDate = dateStr;
            option.endDate = '';
          } else if (!option.endDate) {
            if (date < new Date(option.startDate + 'T00:00:00')) {
              option.endDate = option.startDate;
              option.startDate = dateStr;
            } else {
              option.endDate = dateStr;
            }
          } else {
            option.startDate = dateStr;
            option.endDate = '';
          }
          paintWeek();
        });
      });

      const len = (state.vacationDates[state.currentWeekIndex]?.length||0);
      $btnAddOpt.disabled = !(len < 2); $btnRemOpt.disabled = !(len > 1);
    }


    function addOption(){ const arr = state.vacationDates[state.currentWeekIndex]; if (arr.length<2){ arr.push({startDate:'',endDate:''}); paintWeek(); } }
    function removeOption(){ const arr = state.vacationDates[state.currentWeekIndex]; if (arr.length>1){ arr.splice(1,1); paintWeek(); } }
    function allDatesFilled(){ return state.vacationDates.every(week => week.every(o=>o.startDate && o.endDate)); }


    async function submitRequest(){
      if (!$name.value || !$seniority.value) return notify("Please fill in your name and seniority date.");
      if (state.weeks===0) return notify("You currently have 0 vacation weeks.");
      if (!allDatesFilled()) return notify("Please fill in all requested vacation dates.");
      if (!state.backend.ready) {
        console.log('Backend not ready, waiting for initialization...');
        await initBackend();
      }
      const payload = { name:$name.value, seniorityDate:$seniority.value, vacationDates: state.vacationDates, yearsOfService: state.years, status:'pending', userId: state.backend.userId, submittedAt: Date.now() };
      try { 
        await backendAdd(payload); 
        state.currentWeekIndex = 0; // Reset week index
        recomputeFromSeniority(); // Re-initialize state based on form values
        navigate('confirmation'); 
      } catch(e){ console.error(e); notify("Failed to submit request. Please try again."); }
    }


    // Supervisor
    const $tbody = $('#requests-tbody');
    function paintSupervisor(){
      const items=[...state.supervisor.items].sort((a,b)=> new Date(a.seniorityDate)-new Date(b.seniorityDate));
      if (!items.length){ $tbody.innerHTML = `<tr><td colspan="6" class="center muted">No vacation requests at this time.</td></tr>`; return; }
      $tbody.innerHTML='';
      items.forEach(req=>{
        const vdates = Array.isArray(req.vacationDates)?req.vacationDates:[];
        const datesHTML = vdates.map((week,i)=>{
          const status = (Array.isArray(week) && week[0]?.status) || 'pending';
          const lines = (Array.isArray(week)?week:[]).map((o,j)=>`<div class="muted" style="font-size:12px">Option ${j+1}: ${fmtDateISOToMDY(o.startDate)} to ${fmtDateISOToMDY(o.endDate)}</div>`).join('');
          return `
            <div style="margin-bottom:6px">
              <strong>Week ${i+1}:</strong>
              <div>${lines||'<span class=\"muted\">No dates</span>'}</div>
              <div class="toolbar" style="margin-top:4px">
                <span class="pill ${status.toUpperCase()}">${status.toUpperCase()}</span>
                ${status === 'pending' ? `
                  <button data-id="${req.id}" data-week-index="${i}" data-act="approve-week">Approve</button>
                  <button class="bad" data-id="${req.id}" data-week-index="${i}" data-act="reject-week">Reject</button>
                ` : ''}
              </div>
            </div>`;
        }).join('');

        const requestStatus = req.status || 'pending';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${req.name}</td>
          <td class="muted">${fmtDateISOToMDY(req.seniorityDate)}</td>
          <td class="muted">${req.yearsOfService ?? ''}</td>
          <td>${datesHTML || '<span class="muted">—</span>'}</td>
          <td><span class="pill ${requestStatus.toUpperCase()}">${requestStatus.toUpperCase()}</span></td>
          <td>
            ${requestStatus === 'pending' ? `<div class="toolbar"><button data-act="approve" data-id="${req.id}">Approve All</button><button class="bad" data-act="reject" data-id="${req.id}">Reject All</button></div>` : ''}
          </td>`;
        $tbody.appendChild(tr);
      });
    }


    $tbody.addEventListener('click', async e=>{
      const btn = e.target.closest('button[data-act]'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const weekIndex = btn.getAttribute('data-week-index');

      // Find the request in the current state
      const request = state.supervisor.items.find(req => req.id === id);
      if (!request) return;

      try {
        if (act === 'approve-week' || act === 'reject-week') {
          // Update status for a specific week
          const newStatus = act === 'approve-week' ? 'approved' : 'rejected';
          request.vacationDates[weekIndex][0].status = newStatus;

          // Check if all weeks are resolved to update the main status
          const allResolved = request.vacationDates.every(week => week[0]?.status !== 'pending');
          const allApproved = request.vacationDates.every(week => week[0]?.status === 'approved');
          const newRequestStatus = allResolved ? (allApproved ? 'approved' : 'rejected') : 'pending';

          await backendUpdate(id, {
            vacationDates: request.vacationDates,
            status: newRequestStatus,
            updatedAt: Date.now()
          });

          notify(`Vacation week ${parseInt(weekIndex) + 1} updated successfully!`);

        } else if (act === 'approve') {
          await backendUpdate(id, { status: 'approved', approvedAt: Date.now() });
          notify('Vacation approved successfully!');
        } else if (act === 'reject') {
          await backendUpdate(id, { status: 'rejected', rejectedAt: Date.now() });
          notify('Vacation rejected.');
        }
      }
      catch(err){ console.error(err); notify('Failed to update request.'); }
    });


    function getDatesInRange(a,b){ const out=[]; const d=new Date(a); const stop=new Date(b); if (Number.isNaN(d)||Number.isNaN(stop)) return out; while(d<=stop){ out.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1);} return out; }
    async function allocateAll(){
      if (!state.backend.ready) {
        console.log('Backend not ready, waiting for initialization...');
        await initBackend();
      }
      notify('Allocating pending requests based on seniority...', 1500);
      const items=[...state.supervisor.items].filter(r=>r.status==='pending').sort((a,b)=> new Date(a.seniorityDate)-new Date(b.seniorityDate));
      const allocated=new Set();
      const updates = [];

      for (const req of items){
        // Ensure vacationDates is an array and not an empty one
        if (!req.vacationDates || req.vacationDates.length === 0) {
            updates.push({ id: req.id, patch: { status: 'rejected', rejectedAt: Date.now() } });
            continue;
        }

        const updatedVacationDates = JSON.parse(JSON.stringify(req.vacationDates)); // Deep copy
        let requestStatus = 'pending';

        for (let i = 0; i < updatedVacationDates.length; i++) {
          const week = updatedVacationDates[i];
          const option = week[0];

          if (option && option.startDate && option.endDate && option.status === 'pending') {
            const dates = getDatesInRange(option.startDate, option.endDate);
            let conflict = false;
            for (const d of dates) {
              if (allocated.has(d)) {
                conflict = true;
                break;
              }
            }

            if (conflict) {
              option.status = 'rejected';
            } else {
              option.status = 'approved';
              for (const d of dates) {
                allocated.add(d);
              }
            }
          }
        }

        // Add defensive checks to ensure updatedVacationDates is an array before calling every()
        const allApproved = updatedVacationDates && Array.isArray(updatedVacationDates) && updatedVacationDates.every(week => week[0]?.status === 'approved');
        const allRejected = updatedVacationDates && Array.isArray(updatedVacationDates) && updatedVacationDates.every(week => week[0]?.status === 'rejected');
        
        if(allApproved) {
            requestStatus = 'approved';
        } else if (allRejected) {
            requestStatus = 'rejected';
        }

        updates.push({
            id: req.id,
            patch: {
                vacationDates: updatedVacationDates,
                status: requestStatus,
                updatedAt: Date.now()
            }
        });
      }

      await Promise.all(updates.map(u => backendUpdate(u.id, u.patch)));
      notify(`Allocated requests. Statuses have been updated.`);
    }
    
    async function resetAll(){ 
        if (!state.backend.ready) {
            console.log('Backend not ready, waiting for initialization...');
            await initBackend();
        }
        notify('Resetting all requests...', 1200); 
        const ups=state.supervisor.items.map(r=>backendUpdate(r.id,{status:'pending'})); await Promise.all(ups); notify(`Reset ${ups.length} request(s) to pending.`); }


    // Backend (memory/Firestore)
    const memory = {
      _data: [], _id(){ return Math.random().toString(36).slice(2,10); },
      async list(){ return JSON.parse(JSON.stringify(this._data)); },
      async add(doc){ const id=this._id(); this._data.push({...doc, id, vacationDates: doc.vacationDates}); return id; },
      async update(id, patch){ const i=this._data.findIndex(x=>x.id===id); if (i>=0) this._data[i] = {...this._data[i], ...patch}; },
      seed(){ if (this._data.length) return; const seed=[
        {name:'Jane Doe', seniorityDate:'2018-05-15', vacationDates: [[{startDate:'2026-07-01',endDate:'2026-07-07', status:'pending'}],[{startDate:'2026-08-10',endDate:'2026-08-17', status:'pending'}]] , yearsOfService:7, status:'pending'},
        {name:'Robert Brown', seniorityDate:'2020-03-20', vacationDates: [[{startDate:'2026-09-05',endDate:'2026-09-12', status:'pending'}]] , yearsOfService:5, status:'pending'},
        {name:'Emily White', seniorityDate:'2012-01-10', vacationDates: [[{startDate:'2026-06-01',endDate:'2026-06-07', status:'approved'}],[{startDate:'2026-06-15',endDate:'2026-06-22', status:'approved'}],[{startDate:'2026-07-01',endDate:'2026-07-07', status:'approved'}]] , yearsOfService:13, status:'approved'},
        {name:'Michael Green', seniorityDate:'2024-02-28', vacationDates: [[{startDate:'2026-11-01',endDate:'2026-11-08', status:'pending'}]] , yearsOfService:1, status:'pending'},
        {name:'Olivia Jones', seniorityDate:'2019-09-01', vacationDates: [[{startDate:'2026-09-20',endDate:'2026-09-27', status:'rejected'}],[{startDate:'2026-10-05',endDate:'2026-10-12', status:'rejected'}]] , yearsOfService:6, status:'rejected'},
      ]; seed.forEach(s=> this._data.push({...s, id:this._id()})); }
    };


    async function initBackend(){
      if (typeof __firebase_config !== 'undefined' && __firebase_config && Object.keys(JSON.parse(__firebase_config)).length > 0) {
        try {
          const firebaseConfig = JSON.parse(__firebase_config);
          const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, serverTimestamp, getDocs } = window._fb;
          if (!initializeApp || !getAuth || !getFirestore) {
            console.error('Firebase functions are not available on window._fb.');
            throw new Error('Firebase library not fully loaded.');
          }
          const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          const app = initializeApp(firebaseConfig);
          const auth = getAuth(app);
          state.backend.db = getFirestore(app);
          state.backend.appId = appId;
          await new Promise(resolve=>{ onAuthStateChanged(auth, async user=>{ if (user){ state.backend.userId=user.uid; console.log("Firebase initialized. User ID: ", state.backend.userId); state.backend.mode='firestore'; state.backend.ready=true; resolve(); } else { try { if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch(e){ console.warn('Auth failed; memory mode.', e); state.backend.mode='memory'; state.backend.ready=true; resolve(); } } }); });
          try { // seed if empty
            const colRef = collection(state.backend.db, `artifacts/${state.backend.appId}/public/data/vacation_requests`);
            const snap = await getDocs(colRef);
            if (snap.empty){ memory.seed(); for (const s of memory._data){ await addDoc(colRef, { name:s.name, seniorityDate:s.seniorityDate, vacationDates: JSON.stringify(s.vacationDates), yearsOfService:s.yearsOfService, status:s.status, submittedAt: serverTimestamp(), userId: state.backend.userId }); } }
          } catch(e){ console.warn('Seeding failed; but continuing with firestore anyway...', e); }
          return;
        } catch(e){ console.warn('Firebase init error; using memory.', e); }
      }
      state.backend.mode='memory'; state.backend.ready=true; memory.seed();
    }


    async function backendList(){
      console.log('backendList() called. Mode:', state.backend.mode);
      if (state.backend.mode==='firestore'){
        const colRef = window._fb.collection(state.backend.db, `artifacts/${state.backend.appId}/public/data/vacation_requests`);
        const q = window._fb.query(colRef); const out=[]; const snap = await window._fb.getDocs(q);
        snap.forEach(doc=>{ const d=doc.data(); out.push({ id:doc.id, ...d, vacationDates: d.vacationDates?JSON.parse(d.vacationDates):[] }); });
        return out;
      } else { return memory.list(); }
    }
    async function backendAdd(doc){ 
      console.log('backendAdd() called. Mode:', state.backend.mode);
      if (state.backend.mode==='firestore'){ const colRef = window._fb.collection(state.backend.db, `artifacts/${state.backend.appId}/public/data/vacation_requests`); await window._fb.addDoc(colRef, { ...doc, vacationDates: JSON.stringify(doc.vacationDates) }); } else { await memory.add(doc); } await refreshSupervisor(); }
    async function backendUpdate(id, patch){ 
      console.log('backendUpdate() called. Mode:', state.backend.mode);
      if (state.backend.mode==='firestore'){ 
        if (patch.vacationDates) {
          patch.vacationDates = JSON.stringify(patch.vacationDates);
        }
        const ref = window._fb.doc(state.backend.db, `artifacts/${state.backend.appId}/public/data/vacation_requests`, id); 
        await window._fb.updateDoc(ref, patch); 
      } else { await memory.update(id, patch); } await refreshSupervisor(); }
    async function refreshSupervisor(){ state.supervisor.items = await backendList(); paintSupervisor(); }
    async function loadSupervisor(){ if (!state.backend.ready) { console.log('Backend not ready, waiting for initialization...'); await initBackend(); } await refreshSupervisor(); }


    // Nav events
    $('#go-employee').addEventListener('click', ()=> navigate('employee'));
    $('#go-supervisor').addEventListener('click', ()=> navigate('supervisor'));
    $('#back-from-employee').addEventListener('click', ()=> navigate('home'));
    $('#mobile-back').addEventListener('click', ()=> navigate('home'));
    $('#back-from-supervisor').addEventListener('click', ()=> navigate('home'));
    $('#back-from-confirmation').addEventListener('click', ()=> navigate('home'));


    // Employee events
    $name.value = state.name; $seniority.value = state.seniorityDate;
    $name.addEventListener('input', e=> state.name = e.target.value);
    $seniority.addEventListener('change', recomputeFromSeniority);
    $('#btn-prev').addEventListener('click', ()=>{ if (state.currentWeekIndex>0){ state.currentWeekIndex--; paintEmployeeStats(); paintWeek(); } });
    $('#btn-next').addEventListener('click', ()=>{ if (state.currentWeekIndex < state.weeks-1){ state.currentWeekIndex++; paintEmployeeStats(); paintWeek(); } });
    $('#btn-submit').addEventListener('click', submitRequest);
    $('#btn-add-option').addEventListener('click', addOption);
    $('#btn-remove-option').addEventListener('click', removeOption);


    // Supervisor actions
    $('#btn-allocate').addEventListener('click', allocateAll);
    $('#btn-reset').addEventListener('click', resetAll);


    // Boot
    (async function boot(){ 
        window.now = new Date();
        window.now.setUTCHours(0, 0, 0, 0);
        await initBackend(); 
        recomputeFromSeniority(); 
    })();
  </script>
</body>
</html>
