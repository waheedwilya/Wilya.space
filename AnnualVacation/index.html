import React, { useEffect, useMemo, useState } from "react";

// ------- Helpers -------
const fmtDateISOToMDY = (iso?: string) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(d.getUTCDate()).padStart(2, "0");
  const yy = d.getUTCFullYear();
  return `${mm}/${dd}/${yy}`;
};

const weeksFromYears = (years: number) => {
  if (years >= 35) return 6;
  if (years >= 25) return 5;
  if (years >= 10) return 4;
  if (years >= 3) return 3;
  if (years >= 1) return 2;
  return 0;
};

const getDatesInRange = (a?: string, b?: string) => {
  const out: string[] = [];
  if (!a || !b) return out;
  const start = new Date(a);
  const end = new Date(b);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return out;
  const d = new Date(start);
  while (d <= end) {
    out.push(d.toISOString().slice(0,10));
    d.setDate(d.getDate()+1);
  }
  return out;
};

// ------- Types -------
export type VacationOption = { startDate: string; endDate: string };
export type VacationWeeks = VacationOption[][]; // week -> [option1, option2?]

export type RequestRow = {
  id: string;
  name: string;
  seniorityDate: string;
  yearsOfService: number;
  status: "pending" | "approved" | "rejected";
  vacationDates?: VacationWeeks;
};

// ------- Memory backend -------
const memory = {
  _data: [] as RequestRow[],
  _id() { return Math.random().toString(36).slice(2, 10); },
  async list() { return JSON.parse(JSON.stringify(this._data)) as RequestRow[]; },
  async add(doc: Omit<RequestRow, "id">) { const id = this._id(); this._data.unshift({ ...doc, id }); return id; },
  async update(id: string, patch: Partial<RequestRow>) {
    const i = this._data.findIndex(x => x.id === id);
    if (i >= 0) this._data[i] = { ...this._data[i], ...patch } as RequestRow;
  },
  seed() {
    if (this._data.length) return;
    this._data.push({ id: this._id(), name: "Jane Doe", seniorityDate: "2018-05-15", yearsOfService: 7, status: "pending", vacationDates: [ [{startDate:"2026-07-01", endDate:"2026-07-07"}] ] });
    this._data.push({ id: this._id(), name: "Robert Brown", seniorityDate: "2020-03-20", yearsOfService: 5, status: "pending", vacationDates: [ [{startDate:"2026-09-05", endDate:"2026-09-12"}] ] });
    this._data.push({ id: this._id(), name: "Emily White", seniorityDate: "2012-01-10", yearsOfService: 13, status: "approved", vacationDates: [ [{startDate:"2026-06-01", endDate:"2026-06-07"}], [{startDate:"2026-06-15", endDate:"2026-06-22"}] ] });
  }
};

// ------- UI bits -------
const Btn: React.FC<React.PropsWithChildren<{ className?: string; variant?: "primary" | "secondary" | "ghost" | "danger" | "warn" }>> = ({ children, className = "", variant = "primary", ...props }) => (
  <button className={`btn ${variant === "secondary" ? "secondary" : variant === "ghost" ? "ghost" : variant === "danger" ? "bad" : variant === "warn" ? "warn" : ""} ${className}`} {...props}>
    {children}
  </button>
);

const Icon = {
  calendar: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/></svg>
  ),
  clipboard: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="8" y="3" width="8" height="4" rx="1"/><rect x="5" y="7" width="14" height="14" rx="2"/></svg>
  ),
  check: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m20 6-11 11L4 12"/></svg>
  ),
  x: (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
  )
};

// ------- Employee form (Phone Mock with Weeks/Options) -------
const EmployeeForm: React.FC<{ onBack: () => void; onSubmit: (row: Omit<RequestRow, "id">) => void; }> = ({ onBack, onSubmit }) => {
  const [name, setName] = useState("John Doe");
  const [seniority, setSeniority] = useState("2015-01-01");
  const yearsOfService = useMemo(() => {
    if (!seniority) return 0;
    const s = new Date(seniority), t = new Date();
    return Math.max(0, Math.floor((t.getTime() - s.getTime()) / (1000*3600*24*365.25)));
  }, [seniority]);

  const weeks = useMemo(() => weeksFromYears(yearsOfService), [yearsOfService]);
  const [currentWeek, setCurrentWeek] = useState(0);
  const [weeksData, setWeeksData] = useState<VacationWeeks>([]);

  // Keep weeksData length in sync with weeks earned
  useEffect(() => {
    setWeeksData(prev => {
      const next = Array.from({ length: weeks }, (_, i) => prev[i] ?? [{ startDate: "", endDate: "" }]);
      if (currentWeek >= weeks) setCurrentWeek(Math.max(0, weeks - 1));
      return next;
    });
  }, [weeks]);

  const weekArr = weeksData[currentWeek] || [{ startDate: "", endDate: "" }];

  const updateOpt = (idx: number, field: keyof VacationOption, value: string) => {
    setWeeksData(prev => {
      const copy = prev.slice();
      const arr = (copy[currentWeek] ? copy[currentWeek].slice() : [{ startDate: "", endDate: "" }]) as VacationOption[];
      arr[idx] = { ...arr[idx], [field]: value } as VacationOption;
      copy[currentWeek] = arr;
      return copy;
    });
  };

  const addOption = () => setWeeksData(prev => {
    const copy = prev.slice();
    const arr = (copy[currentWeek] ? copy[currentWeek].slice() : []) as VacationOption[];
    if (arr.length < 2) arr.push({ startDate: "", endDate: "" });
    copy[currentWeek] = arr;
    return copy;
  });

  const removeOption = () => setWeeksData(prev => {
    const copy = prev.slice();
    const arr = (copy[currentWeek] ? copy[currentWeek].slice() : []) as VacationOption[];
    if (arr.length > 1) arr.splice(1, 1);
    copy[currentWeek] = arr.length ? arr : [{ startDate: "", endDate: "" }];
    return copy;
  });

  const canPrev = currentWeek > 0;
  const canNext = currentWeek < Math.max(0, weeks - 1);
  const allWeeksFilled = weeksData.slice(0, weeks).every(week => (week?.[0]?.startDate && week?.[0]?.endDate));
  const canSubmit = weeks > 0 && allWeeksFilled && !canNext && name.trim().length > 1 && !!seniority;

  return (
    <div className="card">
      <div className="toolbar" style={{ marginBottom: 12 }}>
        <button className="btn ghost" onClick={onBack}>&larr; Back to Home</button>
      </div>

      <div className="phone-shell">
        <div className="phone-body">
          <div className="phone-notch" />
          <div className="phone-screen" role="region" aria-label="Mobile preview">
            <div className="appbar">
              <button className="appbar-btn" onClick={onBack} title="Back">&larr;</button>
              <div>Employee Vacation Request</div>
            </div>

            <div className="phone-content">
              <div className="row wrap">
                <div className="col">
                  <label>Name</label>
                  <input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Your name" />
                </div>
                <div className="col">
                  <label>Seniority Date</label>
                  <input type="date" value={seniority} onChange={e=>setSeniority(e.target.value)} />
                </div>
              </div>

              <div className="statbar" style={{ marginTop: 12 }}>
                <div>Years of Service: <strong>{yearsOfService}</strong></div>
                <div>Weeks of Vacation: <strong>{weeks}</strong></div>
              </div>

              {/* Week navigator and options */}
              <h2 style={{ marginTop: 16 }}>Request Weeks</h2>
              <div className="toolbar" style={{ justifyContent: "space-between" }}>
                <div className="muted">Week <strong>{weeks === 0 ? 0 : currentWeek + 1}</strong> of <strong>{weeks}</strong></div>
                <div className="toolbar">
                  <button className="chip-btn" onClick={addOption} disabled={weekArr.length >= 2} title="Add Option">+</button>
                  <button className="chip-btn warn" onClick={removeOption} disabled={weekArr.length <= 1} title="Remove Option">âˆ’</button>
                </div>
              </div>

              <div>
                {weeks > 0 && weekArr.map((opt, idx) => (
                  <div key={idx} className="option-card">
                    <div className="muted" style={{ marginBottom: 6 }}>Option {idx + 1}</div>
                    <div className="row wrap">
                      <div className="col">
                        <label>Start Date</label>
                        <input type="date" min="2026-01-01" max="2026-12-31" value={opt.startDate || ""} onChange={(e) => updateOpt(idx, "startDate", e.target.value)} />
                      </div>
                      <div className="col">
                        <label>End Date</label>
                        <input type="date" min="2026-01-01" max="2026-12-31" value={opt.endDate || ""} onChange={(e) => updateOpt(idx, "endDate", e.target.value)} />
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <div className="toolbar" style={{ justifyContent: "space-between", marginTop: 12 }}>
                <button className="btn secondary" onClick={() => setCurrentWeek(Math.max(0, currentWeek - 1))} disabled={!canPrev}>Previous</button>
                <div className="toolbar">
                  {canNext && (
                    <button className="btn" onClick={() => setCurrentWeek(Math.min(weeks - 1, currentWeek + 1))}>Next</button>
                  )}
                  {canSubmit && (
                    <button className="btn ok" onClick={() => onSubmit({ name, seniorityDate: seniority, yearsOfService, status: "pending", vacationDates: weeksData })}>{Icon.check} Submit Request</button>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ------- Supervisor table -------
const SupervisorTable: React.FC<{ items: RequestRow[]; onAct: (id: string, action: "approve" | "reject") => void; onBack: () => void; onAllocateAll: () => void; onResetAll: () => void; }> = ({ items, onAct, onBack, onAllocateAll, onResetAll }) => {
  const sorted = useMemo(() => [...items].sort((a,b)=> new Date(a.seniorityDate).getTime() - new Date(b.seniorityDate).getTime()), [items]);
  return (
    <div className="card">
      <div className="toolbar" style={{ marginBottom: 12 }}>
        <button className="btn ghost" onClick={onBack}>&larr; Back to Home</button>
      </div>
      <h2 style={{ margin: "0 0 8px" }}>Supervisor Dashboard</h2>
      <div className="toolbar" style={{ justifyContent: "space-between", marginBottom: 8 }}>
        <div className="toolbar">
          <button className="btn" onClick={onAllocateAll}>Auto Allocate</button>
          <button className="btn secondary" onClick={onResetAll}>Reset Leaves</button>
        </div>
        <span className="muted">Sorted by seniority (oldest first)</span>
      </div>
      <div className="card" style={{ padding: 0 }}>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Seniority Date</th>
              <th>Years</th>
              <th>Requested Dates</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {sorted.map(req => (
              <tr key={req.id}>
                <td>{req.name}</td>
                <td className="muted">{fmtDateISOToMDY(req.seniorityDate)}</td>
                <td className="muted">{req.yearsOfService}</td>
                <td>
                  {(req.vacationDates || []).map((week, i) => (
                    <div key={i} style={{ marginBottom: 6 }}>
                      <strong>Week {i + 1}:</strong>
                      <div>
                        {(week || []).map((o, j) => (
                          <div key={j} className="muted" style={{ fontSize: 12 }}>
                            Option {j + 1}: {fmtDateISOToMDY(o.startDate)} to {fmtDateISOToMDY(o.endDate)}
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </td>
                <td>
                  <span className="pill" style={{ background: req.status === 'pending' ? '#fef3c7' : req.status === 'approved' ? '#dcfce7' : '#fee2e2', color: req.status === 'pending' ? '#92400e' : req.status === 'approved' ? '#166534' : '#991b1b' }}>
                    {req.status.toUpperCase()}
                  </span>
                </td>
                <td>
                  {req.status === "pending" && (
                    <div className="toolbar">
                      <button className="btn" onClick={() => onAct(req.id,"approve")}>{Icon.check} Approve</button>
                      <button className="btn bad" onClick={() => onAct(req.id,"reject")}>{Icon.x} Reject</button>
                    </div>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// ------- App -------
export default function App() {
  const styles = `
    :root { --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --card:#ffffff; --brand:#0F2133; --ok:#16a34a; --warn:#374151; --bad:#dc2626; }
    * { box-sizing: border-box; }
    body, .app-root { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; color:var(--ink); background:var(--bg); }
    .container { max-width: 1024px; margin: 24px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding:24px; }
    h1 { margin:0 0 16px; font-size:28px; }
    .row { display:flex; gap:12px; align-items:center; }
    .row.wrap { flex-wrap: wrap; }
    .col { flex:1; min-width: 220px; }
    label { display:block; font-size:14px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="date"] { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; background:#fff; }
    input:focus { border-color:#93c5fd; box-shadow:0 0 0 4px rgba(2,132,199,.15); }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .btn { appearance:none; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; background:var(--brand); color:white; display:inline-flex; gap:8px; align-items:center; }
    .btn.secondary { background:#6b7280; }
    .btn.ghost { background:transparent; color:#2563eb; padding:0; }
    .btn.ok { background:var(--ok); }
    .btn.bad { background:var(--bad); }
    .btn.warn { background:var(--warn); }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:12px; text-align:left; border-bottom:1px solid #f1f5f9; vertical-align: top; }
    thead th { font-size:12px; letter-spacing:.06em; color:#6b7280; text-transform:uppercase; }
    .muted { color:var(--muted); }

    /* Phone mock styles */
    .phone-shell { display:flex; justify-content:center; }
    .phone-body { position:relative; width:390px; height:780px; background:#000; border-radius:36px; padding:12px; box-shadow: 0 20px 60px rgba(0,0,0,.35); }
    .phone-body:before { content:""; position:absolute; right:-4px; top:120px; width:3px; height:80px; background:#0e0e0e; border-radius:2px; }
    .phone-screen { position:relative; width:100%; height:100%; border-radius:28px; background:#f3f4f6; overflow:hidden; display:flex; flex-direction:column; }
    .phone-notch { position:absolute; top:8px; left:50%; transform:translateX(-50%); width:180px; height:24px; background:#000; border-radius:0 0 18px 18px; z-index:2; }
    .appbar { height:56px; background:var(--brand); color:white; display:flex; align-items:center; gap:10px; padding:0 14px; font-weight:700; position:relative; z-index:1; }
    .appbar-btn { background:transparent; border:0; color:white; padding:6px 8px; border-radius:8px; cursor:pointer; }
    .phone-content { flex:1; overflow-y:auto; padding:16px; }
    .phone-content .row { flex-direction:column; align-items:stretch; }
    .phone-content .col { min-width: unset; }
    .statbar { display:flex; justify-content:space-between; background:#f8fafc; padding:10px 12px; border-radius:10px; }
    .chip-btn { width:28px; height:28px; border-radius:999px; display:grid; place-items:center; font-weight:800; background:#fff; border:1px solid #e5e7eb; color:#111827; }
    .chip-btn.warn { background:#374151; color:#fff; border-color:#374151; }
    .option-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:8px 0; }
  `;

  const [route, setRoute] = useState<"home" | "employee" | "supervisor">("home");
  const [items, setItems] = useState<RequestRow[]>([]);
  const [notice, setNotice] = useState<string | null>(null);

  useEffect(() => { memory.seed(); memory.list().then(setItems); }, []);

  const onSubmit = async (row: Omit<RequestRow, "id">) => {
    await memory.add(row);
    setItems(await memory.list());
    setNotice("Request submitted");
    setRoute("supervisor");
  };

  const act = async (id: string, action: "approve" | "reject") => {
    await memory.update(id, { status: action === "approve" ? "approved" : "rejected" });
    setItems(await memory.list());
    setNotice(action === "approve" ? "Vacation approved successfully!" : "Vacation rejected.");
  };

  const allocateAll = async () => {
    const list = await memory.list();
    // Seed allocated calendar with already approved requests
    const allocated = new Set<string>();
    for (const r of list) {
      if (r.status === "approved") {
        for (const week of (r.vacationDates || [])) {
          const opt = Array.isArray(week) ? week[0] : undefined;
          if (!opt) continue;
          for (const d of getDatesInRange(opt.startDate, opt.endDate)) allocated.add(d);
        }
      }
    }

    const pending = list.filter(r => r.status === "pending").sort((a,b)=> new Date(a.seniorityDate).getTime() - new Date(b.seniorityDate).getTime());
    let approvedCount = 0, rejectedCount = 0;

    for (const req of pending) {
      const weeks = req.vacationDates || [];
      let ok = true;
      const reserve: string[] = [];
      for (const week of weeks) {
        const options = Array.isArray(week) ? week : [];
        let chosen: string[] | null = null;
        for (const opt of options) {
          const dates = getDatesInRange(opt?.startDate, opt?.endDate);
          if (dates.length === 0) continue;
          if (!dates.some(d => allocated.has(d) || reserve.includes(d))) {
            chosen = dates;
            break;
          }
        }
        if (chosen) {
          reserve.push(...chosen);
        } else {
          ok = false;
          break;
        }
      }
      if (ok) {
        reserve.forEach(d => allocated.add(d));
        await memory.update(req.id, { status: "approved" });
        approvedCount++;
      } else {
        await memory.update(req.id, { status: "rejected" });
        rejectedCount++;
      }
    }

    setItems(await memory.list());
    setNotice(`Auto allocated: ${approvedCount} approved, ${rejectedCount} rejected.`);
  };

  const resetAll = async () => {
    const list = await memory.list();
    await Promise.all(list.map(r => memory.update(r.id, { status: "pending" })));
    setItems(await memory.list());
    setNotice(`Reset ${list.length} request(s) to pending.`);
  };

  return (
    <div className="app-root">
      <style>{styles}</style>
      <div className="container">
        {route === "home" && (
          <div className="card">
            <h1>Vacation Planner</h1>
            <div className="toolbar">
              <Btn onClick={() => setRoute("employee")}>{Icon.calendar} Employee Vacation Request</Btn>
              <Btn variant="warn" onClick={() => setRoute("supervisor")}>{Icon.clipboard} Supervisor Dashboard</Btn>
            </div>
          </div>
        )}

        {route === "employee" && (
          <EmployeeForm onBack={() => setRoute("home")} onSubmit={onSubmit} />
        )}

        {route === "supervisor" && (
          <SupervisorTable items={items} onAct={act} onBack={() => setRoute("home")} onAllocateAll={allocateAll} onResetAll={resetAll} />
        )}

        {notice && (
          <div className="card" style={{ position: "fixed", left: 16, bottom: 16 }}>
            <div>{notice}</div>
            <Btn variant="ghost" onClick={() => setNotice(null)}>Close</Btn>
          </div>
        )}
      </div>
    </div>
  );
}
